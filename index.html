<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ADMI â€” Consulta de despachos</title>
  <style>
    :root{
      --bg:#0f172a;      /* azul oscuro */
      --card:#111827;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --accent:#2563eb;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#dc2626;
      --shadow: rgba(0,0,0,.35);
    }
    *{ box-sizing:border-box }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;
      background:var(--bg); color:var(--text);
    }
    .wrap{ max-width:1100px; margin:32px auto; padding:0 16px; }
    .title{ font-weight:700; font-size:24px; margin-bottom:16px; display:flex; align-items:center; gap:10px }

    .card{ background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:16px; transition: box-shadow .2s ease, border-color .2s ease, transform .15s ease; }
    .card:hover{ box-shadow: 0 8px 24px var(--shadow); border-color:#263241; }

    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .col{ flex:1 1 220px; }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }

    input,button,select{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid #1f2937; background:#0b1220; color:var(--text);
      outline:none; transition: background-color .2s ease, border-color .2s ease, box-shadow .2s ease, transform .15s ease, filter .2s ease;
    }
    input::placeholder{ color:#64748b }
    input:focus, select:focus{ border-color:#334155; box-shadow:0 0 0 3px rgba(37,99,235,.25); }

    button{ cursor:pointer; background:var(--accent); border:none; font-weight:600 }
    button:hover{ filter:brightness(1.05); transform:translateY(-1px); box-shadow:0 8px 16px var(--shadow); }
    button:active{ transform:translateY(0); box-shadow:none; }
    button.secondary{ background:#0b1220; border:1px solid #1f2937 }
    button.secondary:hover{ border-color:#2b3b52; }

    .tabs{ display:flex; gap:8px; margin-bottom:12px }
    .tab{ padding:10px 14px; border-radius:999px; background:#0b1220; color:var(--muted); cursor:pointer; border:1px solid #1f2937; transition: background-color .2s ease, color .2s ease, border-color .2s ease, transform .15s ease; }
    .tab:hover{ color:#cbd5e1; border-color:#2b3b52; transform:translateY(-1px); }
    .tab.active{ background:var(--accent); color:white; border-color:transparent }

    table{ width:100%; border-collapse:separate; border-spacing:0; margin-top:12px; }
    th, td{ padding:10px 12px; border-bottom:1px solid #1f2937; font-size:14px; text-align:left; }
    tr{ transition: background-color .2s ease; }
    tr:hover td{ background:#0b1220 }

    /* AnimaciÃ³n de entrada de filas */
    tbody tr.row-anim{ opacity: 0; transform: translateY(6px) scale(.98); animation: fadeUp .35s ease forwards; }
    @keyframes fadeUp{ to { opacity:1; transform: translateY(0) scale(1); } }

    .badge{ display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700 }
    .b-ok{ background:rgba(22,163,74,.15); color:#86efac; }
    .b-warn{ background:rgba(245,158,11,.15); color:#fcd34d; }
    .b-bad{ background:rgba(220,38,38,.15); color:#fca5a5; }

    /* Micro-animaciÃ³n badge */
    .badge-anim{ position: relative; animation: pop .25s ease-out, shine 1.2s ease-out; }
    @keyframes pop{ 0% { transform: scale(.92); } 100% { transform: scale(1); } }
    @keyframes shine{ 0% { box-shadow: inset 0 0 0 0 rgba(255,255,255,.0); } 35% { box-shadow: inset 0 0 0 999px rgba(255,255,255,.06); } 100% { box-shadow: inset 0 0 0 0 rgba(255,255,255,0); } }

    .muted{ color:var(--muted) }
    .totals{ display:flex; gap:16px; flex-wrap:wrap; margin-top:8px }
    .pill{ background:#0b1220; border:1px solid #1f2937; border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted) }
    .footer{ margin-top:24px; color:var(--muted); font-size:12px }

    /* Overlay de carga */
    #loading{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); z-index:9999; backdrop-filter: blur(2px); }
    .spinner{ width:44px; height:44px; border-radius:999px; border:4px solid rgba(255,255,255,.2); border-top-color:#fff; animation:spin 1s linear infinite; margin-bottom:10px; }
    @keyframes spin{ to { transform: rotate(360deg); } }
    .loading-box{ display:flex; flex-direction:column; align-items:center; gap:8px; background:#0b1220; border:1px solid #1f2937; padding:16px 18px; border-radius:14px; box-shadow:0 10px 30px var(--shadow); color:#e5e7eb; min-width:220px; }
    .loading-text{ font-size:14px; color:#cbd5e1 }

    /* Toast */
    #toast{ position:fixed; right:16px; bottom:16px; z-index:10000; display:none; background:#0b1220; border:1px solid #1f2937; color:#e5e7eb; padding:10px 14px; border-radius:10px; box-shadow:0 8px 20px var(--shadow); font-size:14px; min-width:200px; opacity:0; transform: translateY(8px); transition: opacity .2s ease, transform .2s ease; }
    #toast.show{ display:block; opacity:1; transform: translateY(0); }
    #toast.ok{ border-color: rgba(22,163,74,.35); }
    #toast.error{ border-color: rgba(220,38,38,.35); }

    /* Botones con spinner */
    button.loading{ position: relative; pointer-events: none; opacity: .9; filter: saturate(1.05); }
    button.loading .btn-text{ opacity: .85; margin-left: 22px; transition: margin-left .2s ease, opacity .2s ease; }
    button.loading::before{ content: ""; position:absolute; left: 10px; top: 50%; width:16px; height:16px; transform: translateY(-50%); border-radius: 50%; border: 2px solid rgba(255,255,255,.35); border-top-color: #fff; animation: spin 1s linear infinite; }

    /* MenÃº 3 puntos */
    .menu{ position: relative; margin-left: 8px; }
    .menu-btn{ width:36px; height:36px; border-radius:10px; border:1px solid #1f2937; background:#0b1220; color:#e5e7eb; display:flex; align-items:center; justify-content:center; cursor:pointer; transition: border-color .2s ease, transform .15s ease; }
    .menu-btn:hover{ border-color:#2b3b52; transform: translateY(-1px); }
    .menu-panel{ position:absolute; right:0; top:calc(100% + 10px); background:#0b1220; border:1px solid #1f2937; border-radius:12px; min-width:260px; box-shadow: 0 12px 32px var(--shadow); padding: 10px; display:none; z-index: 20; animation: panelIn .16s ease; }
    .menu-panel.open{ display:block; }
    @keyframes panelIn{ from{ opacity:0; transform: translateY(-6px);} to{ opacity:1; transform: translateY(0);} }
    .menu-group{ padding:6px 6px 10px; border-bottom:1px solid #1f2937; margin-bottom:8px; }
    .menu-group:last-child{ border-bottom:none; margin-bottom:0; padding-bottom:0; }
    .menu-title{ font-size:12px; color:#94a3b8; margin:0 0 6px 2px; }
    .menu-actions{ display:flex; gap:6px; flex-wrap:wrap; }
    .chip{ padding:8px 10px; border:1px solid #1f2937; border-radius:999px; background:#0b1220; color:#e5e7eb; font-size:12px; cursor:pointer; transition: border-color .2s ease, background-color .2s ease, transform .15s ease; }
    .chip:hover{ border-color:#2b3b52; transform: translateY(-1px); }
    .chip.ok{ background:rgba(22,163,74,.15); color:#86efac; border-color: rgba(22,163,74,.25); }
    .chip.bad{ background:rgba(220,38,38,.15); color:#fca5a5; border-color: rgba(220,38,38,.25); }
    .chip.warn{ background:rgba(245,158,11,.15); color:#fcd34d; border-color: rgba(245,158,11,.25); }
    .menu-row{ display:flex; gap:8px; align-items:center; }
    .menu-row input[type="date"]{ flex:1; }
  </style>
</head>
<body>
  <!-- Overlay de Carga -->
  <div id="loading" aria-hidden="true">
    <div class="loading-box" role="status" aria-live="polite">
      <div class="spinner"></div>
      <div id="loading-text" class="loading-text">Buscandoâ€¦</div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" role="status" aria-live="polite"></div>

  <div class="wrap">
    <div class="title">
      ðŸ“¦ ADMI â€” Consulta de despachos

      <!-- MenÃº 3 puntos -->
      <div class="menu" id="menu">
        <button class="menu-btn" id="menuBtn" aria-haspopup="true" aria-expanded="false" title="Filtros">
          &#8942;
        </button>
        <div class="menu-panel" id="menuPanel" role="menu" aria-hidden="true">
          <div class="menu-group">
            <div class="menu-title">Filtrar por estado</div>
            <div class="menu-actions">
              <button class="chip" onclick="applyQuickStatus('ALL')">Todos</button>
              <button class="chip ok" onclick="applyQuickStatus('ENTREGADO')">Entregados</button>
              <button class="chip bad" onclick="applyQuickStatus('CANCEL')">Cancelados</button>
              <button class="chip warn" onclick="applyQuickStatus('EN CAMINO')">En camino</button>
            </div>
          </div>
          <div class="menu-group">
            <div class="menu-title">Filtrar por fecha + estado</div>
            <div class="menu-row">
              <input type="date" id="fltDate" />
              <select id="fltStatus">
                <option value="ALL">Todos</option>
                <option value="ENTREGADO">Entregados</option>
                <option value="CANCEL">Cancelados</option>
                <option value="EN CAMINO">En camino</option>
              </select>
            </div>
            <div class="menu-actions" style="margin-top:8px;">
              <button class="chip" onclick="applyFilters()">Aplicar</button>
              <button class="chip" onclick="clearFilters()">Quitar filtros</button>
            </div>
          </div>
        </div>
      </div>

      <span style="margin-left:auto; font-size:14px; color:var(--muted)">Usuario</span>
    </div>

    <div class="card">
      <div class="tabs">
        <div class="tab active" id="tab-driver" onclick="switchTab('driver')">Por chofer</div>
        <div class="tab" id="tab-comp" onclick="switchTab('comp')">Por comprobante</div>
      </div>

      <!-- TAB CHOFER -->
      <div id="view-driver">
        <div class="row">
          <div class="col">
            <label>Nombre del chofer</label>
            <input id="inp-name" list="names" placeholder="Ej: Francisco Gutierrez" autocomplete="off" />
            <datalist id="names"></datalist>
          </div>
          <div class="col">
            <label>Fecha</label>
            <input id="inp-date" type="date"/>
          </div>
          <div class="col">
            <label>&nbsp;</label>
            <button id="btn-search-driver" onclick="buscarPorChofer()"><span class="btn-text">Buscar</span></button>
          </div>
          <div class="col">
            <label>&nbsp;</label>
            <button class="secondary" onclick="exportCSV()"><span class="btn-text">Exportar CSV</span></button>
          </div>
        </div>

        <div class="totals" id="totals" style="display:none;">
          <span class="pill" id="t-paq">PAQ: 0</span>
          <span class="pill" id="t-first">Primero: -</span>
          <span class="pill" id="t-last">Ãšltimo: -</span>
        </div>

        <table id="tbl-driver" style="display:none;">
          <thead>
            <tr>
              <th>NOMBRE</th>
              <th>FECHA DESPACHO</th>
              <th>COMPROBANTE</th>
              <th>CD VENTA</th>
              <th>ESTADO</th>
              <th>FECHA DE ESTADO</th>
              <th>SUB-ESTADO</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- TAB COMPROBANTE -->
      <div id="view-comp" style="display:none;">
        <div class="row">
          <div class="col">
            <label>Comprobante</label>
            <input id="inp-comp" placeholder="Ej: 11230385" autocomplete="off" />
          </div>
          <div class="col">
            <label>CD Venta (opcional)</label>
            <input id="inp-cd" placeholder="Ej: 200001234567890" autocomplete="off" />
          </div>
          <div class="col">
            <label>&nbsp;</label>
            <button id="btn-search-comp" class="secondary" onclick="buscarPorComprobante()"><span class="btn-text">Buscar</span></button>
          </div>
          <div class="col">
            <label>&nbsp;</label>
            <button class="secondary" onclick="exportCSV()"><span class="btn-text">Exportar CSV</span></button>
          </div>
        </div>

        <table id="tbl-comp" style="display:none;">
          <thead>
            <tr>
              <th>NOMBRE</th>
              <th>FECHA DESPACHO</th>
              <th>COMPROBANTE</th>
              <th>CD VENTA</th>
              <th>ESTADO</th>
              <th>FECHA DE ESTADO</th>
              <th>SUB-ESTADO</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="footer">JUCAÂ®</div>
    </div>
  </div>

  <script>
    /* ========= CONFIG DE API ========= */
    const API_BASE = 'https://script.google.com/macros/s/AKfycbxXNv-Y43gncz9phOtluPQuGYgY93owg_OxsAo-LFyPlrsw9R-3yrG8mnstsq4DNUY/exec';
    async function apiGet(params){
      const url = API_BASE + '?' + new URLSearchParams(params);
      const r = await fetch(url, { cache:'no-store' });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    }

    // ======= Estado local =======
    const state = {
      active: 'driver',
      currentRows: [],   // resultados crudos
      viewRows: []       // resultados para mostrar (filtrados)
    };

    // ======= Performance knobs (TURBO) =======
    const MAX_ANIM_ROWS = 600;   // sobre esto, se quitan animaciones de fila
    const CHUNK_SIZE    = 100;   // render en tandas de 100 filas
    const FAST_MODE_AT  = 3000;  // sobre esto, badgeEstado pasa a texto simple

    // ======= NormalizaciÃ³n/fechas (para filtros robustos) =======
    function normTxt(s){
      return String(s||'')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .toUpperCase().replace(/\s+/g,' ').trim();
    }
    function toISODateOnly(anyDateText){
      const t = String(anyDateText||'').trim();
      if (!t) return '';
      let m = t.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (m) return `${m[1]}-${m[2]}-${m[3]}`;
      m = t.match(/^(\d{2})\/(\d{2})\/(\d{4})/);
      if (m) return `${m[3]}-${m[2]}-${m[1]}`;
      const d = new Date(t);
      if (isNaN(d)) return '';
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    // ======= Arranque =======
    (function init(){
      // Cargar nombres para autocompletar
      apiGet({ action:'getNames' }).then(names=>{
        const dl = document.getElementById('names');
        names.forEach(n=>{
          const o = document.createElement('option'); o.value = n; dl.appendChild(o);
        });
      }).catch(console.error);

      // Fecha de hoy por defecto
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,'0');
      const dd = String(today.getDate()).padStart(2,'0');
      document.getElementById('inp-date').value = `${yyyy}-${mm}-${dd}`;

      // abrir/cerrar menÃº
      document.addEventListener('click', (e)=>{
        const panel = document.getElementById('menuPanel');
        const btn = document.getElementById('menuBtn');
        if (btn.contains(e.target)){
          const open = !panel.classList.contains('open');
          panel.classList.toggle('open', open);
          btn.setAttribute('aria-expanded', open ? 'true':'false');
        } else if (!panel.contains(e.target)){
          panel.classList.remove('open');
          btn.setAttribute('aria-expanded', 'false');
        }
      });
    })();

    // ======= UI =======
    function switchTab(kind){
      state.active = kind;
      document.getElementById('tab-driver').classList.toggle('active', kind==='driver');
      document.getElementById('tab-comp').classList.toggle('active', kind==='comp');
      document.getElementById('view-driver').style.display = (kind==='driver'?'block':'none');
      document.getElementById('view-comp').style.display   = (kind==='comp'  ?'block':'none');
      clearTables();
    }

    function clearTables(){
      ['tbl-driver','tbl-comp'].forEach(id=>{
        const el = document.getElementById(id);
        if (!el) return;
        el.style.display='none';
        el.querySelector('tbody').innerHTML='';
      });
      document.getElementById('totals').style.display='none';
      state.viewRows = [];
      state.currentRows = [];
    }

    // ======= Helpers visuales =======
    function setLoading(show, text='Buscandoâ€¦'){
      const overlay = document.getElementById('loading');
      const lt = document.getElementById('loading-text');
      lt.textContent = text;
      overlay.style.display = show ? 'flex' : 'none';
    }
    let toastTimer = null;
    function showToast(msg, kind='info', ms=1600){
      const el = document.getElementById('toast');
      el.className = ''; el.textContent = msg;
      if (kind === 'ok') el.classList.add('ok');
      if (kind === 'error') el.classList.add('error');
      el.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>{ el.classList.remove('show'); }, ms);
    }
    function setButtonLoading(btnId, isLoading){
      const btn = document.getElementById(btnId);
      if (!btn) return;
      btn.classList.toggle('loading', !!isLoading);
      btn.disabled = !!isLoading;
    }

    // ======= Filtros (menÃº 3 puntos) =======
    function applyQuickStatus(status){
      document.getElementById('fltStatus').value = status;
      const dateVal = document.getElementById('fltDate').value || '';
      maybeGlobalFilter(status, dateVal); // intenta traer todos del dÃ­a por estado
      closeMenu();
    }
    function applyFilters(){
      const status = document.getElementById('fltStatus').value || 'ALL';
      const dateVal = document.getElementById('fltDate').value || '';
      maybeGlobalFilter(status, dateVal);
      closeMenu();
    }
    function clearFilters(){
      document.getElementById('fltDate').value = '';
      document.getElementById('fltStatus').value = 'ALL';
      applyFilterToView('ALL', '');
      closeMenu();
    }
    function closeMenu(){
      const panel = document.getElementById('menuPanel');
      const btn = document.getElementById('menuBtn');
      panel.classList.remove('open');
      btn.setAttribute('aria-expanded', 'false');
    }

    // ðŸ’¡ Si hay fecha y status â‰  ALL, intentamos buscar TODO el dÃ­a por ese estado (global).
    // Si falla, caemos al filtro local.
    function maybeGlobalFilter(status, dateISO){
      const hasGlobalIntent = status !== 'ALL' && !!dateISO;
      if (!hasGlobalIntent){
        applyFilterToView(status, dateISO);
        return;
      }
      setLoading(true, 'Buscando todo el dÃ­aâ€¦');
      showToast('Buscando globalâ€¦', 'info', 1200);

      const btnId = (state.active === 'driver') ? 'btn-search-driver' : 'btn-search-comp';
      setButtonLoading(btnId, true);

      apiGet({ action:'searchByDiaEstado', date: dateISO, status })
        .then(rows=>{
          state.currentRows = rows || [];
          state.viewRows = state.currentRows.slice();
          renderRows(state.active==='driver' ? 'tbl-driver' : 'tbl-comp', state.viewRows);
          const tableEl = document.getElementById(state.active==='driver' ? 'tbl-driver' : 'tbl-comp');
          if (tableEl) tableEl.style.display = state.viewRows.length ? 'table' : 'none';
          setLoading(false);
          setButtonLoading(btnId, false);
          showToast(`Listo (global): ${state.viewRows.length}`, 'ok');
        })
        .catch(err=>{
          setLoading(false);
          setButtonLoading(btnId, false);
          showToast('Global no disponible, filtrando localâ€¦', 'error', 1800);
          applyFilterToView(status, dateISO);
        });
    }

    // Filtro robusto por estado + fecha (local)
    function applyFilterToView(status='ALL', dateISO=''){
      const wantISO = String(dateISO||'').slice(0,10);
      const rows = state.currentRows || [];

      const filtered = rows.filter(r=>{
        const st = normTxt(r.estado);

        const isEntregado = st.includes('ENTREG') && !st.includes('NO ENTREG');
        const isCancelado = st.includes('CANCEL') || st.includes('ANUL') || st.includes('RECHAZ');
        const isEnCamino  = st.includes('EN CAMINO') || st.includes('ENCAMINO') ||
                            st.includes('TRANSITO')  || st.includes('TR NSITO');

        const okStatus =
          status==='ALL'       ? true :
          status==='ENTREGADO' ? isEntregado :
          status==='CANCEL'    ? isCancelado :
                                 isEnCamino;

        const rowISO = toISODateOnly(r.fecha_desp);
        const okDate = !wantISO ? true : (rowISO === wantISO);

        return okStatus && okDate;
      });

      state.viewRows = filtered;
      renderRows(state.active==='driver' ? 'tbl-driver' : 'tbl-comp', state.viewRows);
      showToast(`Filtro aplicado: ${state.viewRows.length} resultado(s)`, 'ok', 1400);
    }

    // ======= Buscadores =======
    function buscarPorChofer(){
      ['tbl-driver','tbl-comp'].forEach(id=>{
        const el = document.getElementById(id);
        if (!el) return; el.style.display='none'; el.querySelector('tbody').innerHTML='';
      });
      document.getElementById('totals').style.display='none';
      state.currentRows = []; state.viewRows = [];

      const name = document.getElementById('inp-name').value.trim();
      const date = document.getElementById('inp-date').value;
      if (!name){ alert('IngresÃ¡ un nombre.'); return; }
      if (!date){ alert('SeleccionÃ¡ una fecha.'); return; }

      setLoading(true, 'Buscando por choferâ€¦');
      showToast('Buscandoâ€¦', 'info', 1200);
      setButtonLoading('btn-search-driver', true);

      apiGet({ action:'searchByDriver', name, date })
        .then(res=>{
          state.currentRows = res.rows || [];
          state.viewRows = state.currentRows.slice();
          renderRows('tbl-driver', state.viewRows);
          const t = res.totals || {paq:0,first:'',last:''};
          document.getElementById('t-paq').textContent = `PAQ: ${t.paq}`;
          document.getElementById('t-first').textContent = `Primero: ${t.first || '-'}`;
          document.getElementById('t-last').textContent = `Ãšltimo: ${t.last || '-'}`;
          document.getElementById('totals').style.display = 'flex';
          setLoading(false);
          showToast(`Listo. Resultados: ${state.viewRows.length}`, 'ok');
          setButtonLoading('btn-search-driver', false);
        })
        .catch(err=>{
          setLoading(false);
          setButtonLoading('btn-search-driver', false);
          showToast('Error al buscar', 'error', 2200);
          alert('Error: ' + err.message);
        });
    }

    function buscarPorComprobante(){
      ['tbl-driver','tbl-comp'].forEach(id=>{
        const el = document.getElementById(id);
        if (!el) return; el.style.display='none'; el.querySelector('tbody').innerHTML='';
      });
      state.currentRows = []; state.viewRows = [];

      const comp = document.getElementById('inp-comp').value.trim();
      const cd   = document.getElementById('inp-cd').value.trim();
      if (!comp && !cd){ alert('IngresÃ¡ un comprobante o un CD de venta.'); return; }

      setLoading(true, 'Buscando por comprobanteâ€¦');
      showToast('Buscandoâ€¦', 'info', 1200);
      setButtonLoading('btn-search-comp', true);

      apiGet({ action:'searchByComprobante', comp, cd })
        .then(rows=>{
          state.currentRows = rows || [];
          state.viewRows = state.currentRows.slice();
          renderRows('tbl-comp', state.viewRows);
          setLoading(false);
          showToast(`Listo. Resultados: ${state.viewRows.length}`, 'ok');
          setButtonLoading('btn-search-comp', false);
        })
        .catch(err=>{
          setLoading(false);
          setButtonLoading('btn-search-comp', false);
          showToast('Error al buscar', 'error', 2200);
          alert('Error: ' + err.message);
        });
    }

    // ======= Render (TURBO / chunked) =======
    function renderRows(tableId, rows){
      const tbl = document.getElementById(tableId);
      const tb  = tbl.querySelector('tbody');
      tb.innerHTML = '';

      if (!rows || !rows.length) {
        tbl.style.display = 'none';
        alert('â›” NO SE ENCONTRÃ“ DESPACHO.');
        return;
      }

      const doAnim   = rows.length <= MAX_ANIM_ROWS;
      const fastMode = rows.length >= FAST_MODE_AT;

      let i = 0;
      function paintChunk(){
        const end = Math.min(i + CHUNK_SIZE, rows.length);
        const frag = document.createDocumentFragment();

        for (; i < end; i++){
          const r = rows[i];
          const tr = document.createElement('tr');
          if (doAnim) {
            tr.className = 'row-anim';
            tr.style.animationDelay = (i % 100) * 5 + 'ms';
          }

          const estadoCell = fastMode
            ? `<span class="muted">${esc(r.estado)}</span>`
            : badgeEstado(r.estado);

          tr.innerHTML = `
            <td>${esc(r.nombre)}</td>
            <td class="muted">${esc(r.fecha_desp)}</td>
            <td>${esc(r.comprobante)}</td>
            <td class="muted">${esc(r.cd_venta)}</td>
            <td>${estadoCell}</td>
            <td class="muted">${esc(r.fecha_estado)}</td>
            <td>${esc(r.sub_estado)}</td>
          `;
          frag.appendChild(tr);
        }

        tb.appendChild(frag);

        if (i < rows.length) {
          requestAnimationFrame(paintChunk);
        } else {
          tbl.style.display = 'table';
        }
      }

      requestAnimationFrame(paintChunk);
    }

    function badgeEstado(estado){
      const st = normTxt(estado);
      let cls = 'b-warn';
      const isEntregado = st.includes('ENTREG') && !st.includes('NO ENTREG');
      const isCancelado = st.includes('CANCEL') || st.includes('ANUL') || st.includes('RECHAZ');
      const isCamino    = st.includes('EN CAMINO') || st.includes('ENCAMINO') || st.includes('TRANSITO') || st.includes('TR NSITO');
      if (isEntregado) cls = 'b-ok';
      else if (isCancelado) cls = 'b-bad';
      else if (isCamino) cls = 'b-warn';
      return `<span class="badge ${cls} badge-anim">${esc(estado)}</span>`;
    }

    // ======= Util =======
    function esc(s){ return String(s ?? '').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }
    function exportCSV(){
      if (!state.viewRows.length){ alert('No hay resultados para exportar.'); return; }
      const headers = ['NOMBRE','FECHA DESPACHO','COMPROBANTE','CD VENTA','ESTADO','FECHA DE ESTADO','SUB-ESTADO'];
      const lines = [headers.join(',')];
      state.viewRows.forEach(r=>{
        const row = [r.nombre, r.fecha_desp, r.comprobante, r.cd_venta, r.estado, r.fecha_estado, r.sub_estado]
          .map(v => `"${String(v??'').replace(/"/g,'""')}"`).join(',');
        lines.push(row);
      });
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.download = `despachos-${state.active}-${stamp}.csv`;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }
  </script>
</body>
</html>
